<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload de Recibos - Grupo Tavares</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <style>
    .error-text {
      color: red;
      font-size: 0.9em;
      margin-top: -15px;
    }
    .success-text {
      color: green;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <img src="https://drive.google.com/uc?export=view&id=1gIudZYZ4IsG5q99L8MLSEQ2jMCxeEdpQ" class="logo" alt="Logotipo Grupo Tavares" style="width: 200px; margin: 20px auto; display: block;">
      <h4 class="center-align">Envio de Despesas - Grupo Tavares</h4>
      <form id="uploadForm">
        <!-- Campo Selecionar Arquivo -->
        <div class="file-field input-field">
          <div class="btn">
            <span>Selecionar PDF(s)</span>
            <input type="file" id="arquivo" multiple accept="application/pdf">
          </div>
          <div class="file-path-wrapper">
            <input class="file-path validate" type="text" placeholder="Selecione os arquivos">
          </div>
          <span id="arquivoError" class="error-text" style="display: none;">Por favor, selecione ao menos um arquivo.</span>
        </div>

        <!-- Campo Selecionar Mês -->
        <div class="input-field">
          <select id="mes">
            <option value="" disabled selected>Escolha o mês</option>
            <option value="01">Janeiro</option>
            <option value="02">Fevereiro</option>
            <option value="03">Março</option>
            <option value="04">Abril</option>
            <option value="05">Maio</option>
            <option value="06">Junho</option>
            <option value="07">Julho</option>
            <option value="08">Agosto</option>
            <option value="09">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
          </select>
          <label>Mês</label>
          <span id="mesError" class="error-text" style="display: none;">Por favor, selecione um mês.</span>
        </div>

        <!-- Campo Selecionar Ano -->
        <div class="input-field">
          <select id="ano"></select>
          <label>Ano</label>
          <span id="anoError" class="error-text" style="display: none;">Por favor, selecione um ano.</span>
        </div>

        <!-- Campo Selecionar Despesa -->
        <div class="input-field">
          <input id="despesa" type="text" list="despesas-list" placeholder="Ex: 337050 - Material de Consumo" required>
          <label for="despesa">Conta de Despesa</label>
          <datalist id="despesas-list">
            <option value="004 - Compras a Vista"></option>
            <option value="005 - Compras a Prazo"></option>
            <option value="006 - Pagamentos de Títulos"></option>
            <option value="008 - Devoluções/Trocas (Fornecedores)"></option>
            <option value="014 - Impostos sobre Compras"></option>
            <option value="015 - Impostos sobre Vendas"></option>
            <option value="016 - Custo das Mercadorias Vendidas"></option>
            <option value="019 - Consertos"></option>
            <option value="020 - Adiantamentos"></option>
            <!-- Adicione mais categorias aqui -->
            <option value="999 - Cartão Fidelidade"></option>
          </datalist>
          <span id="despesaError" class="error-text" style="display: none;">Por favor, selecione uma despesa válida.</span>
        </div>

        <!-- Botão de Enviar -->
        <div class="center-align">
          <button type="submit" class="btn waves-effect waves-light">
            <i class="material-icons left">upload</i>Enviar
          </button>
        </div>
      </form>

      <!-- Barra de Progresso -->
      <div class="progress" style="display: none; margin-top: 20px;">
        <div class="indeterminate"></div>
      </div>

      <!-- Status do Upload -->
      <div id="status" style="margin-top: 20px;"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      M.AutoInit();
      const anoAtual = new Date().getFullYear();
      const selectAno = document.getElementById('ano');
      for (let a = anoAtual; a >= anoAtual - 10; a--) {
        const option = document.createElement('option');
        option.value = a;
        option.textContent = a;
        selectAno.appendChild(option);
      }

      document.getElementById('uploadForm').addEventListener('submit', onSubmit);
    });

    function onSubmit(e) {
      e.preventDefault();
      const input = document.getElementById('arquivo');
      const files = [...input.files];
      if (!files.length) return M.toast({ html: 'Selecione ao menos um arquivo.' });

      const mes = document.getElementById('mes').value;
      const ano = document.getElementById('ano').value;
      const despesa = document.getElementById('despesa').value;

      if (!mes || !ano || !despesa) {
        M.toast({ html: 'Preencha todos os campos.' });
        return;
      }

      document.querySelector('.progress').style.display = 'block';

      const arquivos = files.map(file => new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve({
          name: file.name,
          type: file.type,
          data: reader.result.split(',')[1]
        });
        reader.readAsDataURL(file);
      }));

      Promise.all(arquivos).then(blobs => {
        const formObject = { mes, ano, despesa, arquivo: blobs };
        google.script.run
          .withSuccessHandler(handleResponse)
          .withFailureHandler(handleError)
          .uploadFile(formObject);
      });
    }

    function handleResponse(resultsJson) {
      document.querySelector('.progress').style.display = 'none';
      const results = JSON.parse(resultsJson);
      const status = document.getElementById('status');
      results.forEach(r => {
        const div = document.createElement('div');
        div.className = `card-panel ${r.success ? 'green lighten-4 green-text' : 'red lighten-4 red-text'}`;
        div.innerHTML = `<i class="material-icons left">${r.success ? 'check_circle' : 'error'}</i>${r.message}`;
        status.appendChild(div);
      });
    }

    function handleError(error) {
      document.querySelector('.progress').style.display = 'none';
      M.toast({ html: 'Erro: ' + error.message });
    }
  </script>
</body>
</html>
