<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload de Recibos - Grupo Tavares</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
</head>
<body>
  <div class="container">
    <div class="card">
      <img src="https://drive.google.com/uc?export=view&id=1gIudZYZ4IsG5q99L8MLSEQ2jMCxeEdpQ" class="logo" alt="Logotipo Grupo Tavares" style="width: 200px; margin: 20px auto; display: block;">
      <h4 class="center-align">Envio de Despesas - Grupo Tavares</h4>
      <form id="uploadForm">
        <div class="file-field input-field">
          <div class="btn">
            <span>Selecionar PDF(s)</span>
            <input type="file" id="arquivo" multiple accept="application/pdf">
          </div>
          <div class="file-path-wrapper">
            <input class="file-path validate" type="text" placeholder="Selecione os arquivos">
          </div>
        </div>

        <div class="input-field">
          <select id="mes">
            <option value="" disabled selected>Escolha o mês</option>
            <option value="01">Janeiro</option>
            <option value="02">Fevereiro</option>
            <option value="03">Março</option>
            <option value="04">Abril</option>
            <option value="05">Maio</option>
            <option value="06">Junho</option>
            <option value="07">Julho</option>
            <option value="08">Agosto</option>
            <option value="09">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
          </select>
          <label>Mês</label>
        </div>

        <div class="input-field">
          <select id="ano"></select>
          <label>Ano</label>
        </div>

        <div class="input-field">
          <input id="despesa" type="text" placeholder="Ex: 337050 - Material de Consumo" required>
          <label for="despesa">Conta de Despesa</label>
        </div>

        <div class="center-align">
          <button type="submit" class="btn waves-effect waves-light">
            <i class="material-icons left">upload</i>Enviar
          </button>
        </div>
      </form>

      <div class="progress" style="display: none; margin-top: 20px;">
        <div class="indeterminate"></div>
      </div>

      <div id="status" style="margin-top: 20px;"></div>

      <div class="center-align" style="margin-top: 10px;">
        <button class="btn waves-effect grey lighten-1 black-text" id="clearForm" style="display: none;">
          <i class="material-icons left">clear</i>Limpar Formulário
        </button>
        <button class="btn waves-effect teal" id="openDrive">
          <i class="material-icons left">folder</i>Ver Pastas no Drive
        </button>
      </div>

      <footer class="center-align" style="margin-top: 30px;">
        Desenvolvido por 
        <a href="https://github.com/RyannBreston" target="_blank">
          <i class="material-icons">code</i> RyannBreston
        </a>
      </footer>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      M.AutoInit();
      const anoAtual = new Date().getFullYear();
      const selectAno = document.getElementById('ano');
      for (let a = anoAtual; a >= anoAtual - 10; a--) {
        const option = document.createElement('option');
        option.value = a;
        option.textContent = a;
        selectAno.appendChild(option);
      }

      document.getElementById('uploadForm').addEventListener('submit', onSubmit);
      document.getElementById('clearForm').addEventListener('click', clearForm);
      document.getElementById('openDrive').addEventListener('click', () => {
        window.open("https://drive.google.com/drive/u/0/my-drive", "_blank");
      });
    });

    function onSubmit(e) {
      e.preventDefault();
      const input = document.getElementById('arquivo');
      const files = [...input.files];
      if (!files.length) return M.toast({ html: 'Selecione ao menos um arquivo.' });

      const mes = document.getElementById('mes').value;
      const ano = document.getElementById('ano').value;
      const despesa = document.getElementById('despesa').value;

      if (!mes || !ano || !despesa) {
        M.toast({ html: 'Preencha todos os campos.' });
        return;
      }

      document.querySelector('.progress').style.display = 'block';
      document.getElementById('status').innerHTML = '';

      const arquivos = files.map(file => new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve({
          name: file.name,
          type: file.type,
          data: reader.result.split(',')[1]
        });
        reader.readAsDataURL(file);
      }));

      Promise.all(arquivos).then(blobs => {
        const formObject = { mes, ano, despesa, arquivo: blobs };
        google.script.run
          .withSuccessHandler(handleResponse)
          .withFailureHandler(handleError)
          .uploadFile(formObject);
      });
    }

    function handleResponse(resultsJson) {
      document.querySelector('.progress').style.display = 'none';
      const results = JSON.parse(resultsJson);
      const status = document.getElementById('status');
      results.forEach(r => {
        const div = document.createElement('div');
        div.className = `card-panel ${r.success ? 'green lighten-4 green-text' : 'red lighten-4 red-text'}`;
        div.innerHTML = `<i class="material-icons left">${r.success ? 'check_circle' : 'error'}</i>${r.message}`;
        status.appendChild(div);
      });
      document.getElementById('clearForm').style.display = 'inline-block';
    }

    function handleError(error) {
      document.querySelector('.progress').style.display = 'none';
      M.toast({ html: 'Erro: ' + error.message });
    }

    function clearForm() {
      document.getElementById('uploadForm').reset();
      document.getElementById('status').innerHTML = '';
      document.getElementById('clearForm').style.display = 'none';
    }
  </script>
</body>
</html>
