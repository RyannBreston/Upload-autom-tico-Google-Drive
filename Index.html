<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Upload de Despesas - Grupo Tavares</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
</head>
<body>
<div class="container">
  <div class="card" style="margin-top:30px;">
    <h4 class="center-align">Envio de Despesas</h4>
    <form id="uploadForm">
      <div class="file-field input-field">
        <div class="btn">
          <span>Selecionar Arquivo(s)</span>
          <input type="file" id="arquivo" multiple accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <div class="file-path-wrapper">
          <input class="file-path validate" type="text" placeholder="Selecione os arquivos">
        </div>
      </div>
      <div class="input-field">
        <select id="mes" required>
          <option value="" disabled selected>Escolha o mês</option>
          <option value="01">Janeiro</option><option value="02">Fevereiro</option>
          <option value="03">Março</option><option value="04">Abril</option>
          <option value="05">Maio</option><option value="06">Junho</option>
          <option value="07">Julho</option><option value="08">Agosto</option>
          <option value="09">Setembro</option><option value="10">Outubro</option>
          <option value="11">Novembro</option><option value="12">Dezembro</option>
        </select>
        <label>Mês</label>
      </div>
      <div class="input-field">
        <select id="ano" required></select>
        <label>Ano</label>
      </div>
      <div class="input-field">
        <input id="despesa" type="text" required placeholder="Ex: 337050 - Material de Consumo">
        <label for="despesa">Conta de Despesa</label>
      </div>
      <div class="center-align">
        <button type="submit" class="btn waves-effect waves-light">Enviar</button>
      </div>
    </form>
    <div class="progress" id="progressBar" style="display:none;margin-top:20px;">
      <div class="indeterminate"></div>
    </div>
    <div id="status" style="margin-top:20px;"></div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  M.AutoInit();
  // Popular anos
  let anoAtual = new Date().getFullYear();
  let selectAno = document.getElementById('ano');
  for(let a=anoAtual; a >= anoAtual-10; a--) {
    let opt = document.createElement('option');
    opt.value = a; opt.textContent = a;
    selectAno.appendChild(opt);
  }
});

document.getElementById('uploadForm').onsubmit = async function(e){
  e.preventDefault();
  const status = document.getElementById('status');
  status.innerHTML = '';
  let files = document.getElementById('arquivo').files;
  if (!files.length) return M.toast({html: 'Selecione ao menos um arquivo.'});
  let arquivos = [];
  for (let file of files) {
    let base64 = await toBase64(file);
    arquivos.push({name: file.name, type: file.type, data: base64.split(',')[1]});
  }
  let mes = document.getElementById('mes').value;
  let ano = document.getElementById('ano').value;
  let despesa = document.getElementById('despesa').value;
  if (!mes || !ano || !despesa) return M.toast({html: 'Preencha todos os campos.'});

  document.getElementById('progressBar').style.display='block';
  google.script.run.withSuccessHandler(function(resp){
    document.getElementById('progressBar').style.display='none';
    resp.mensagens.forEach(msg => {
      status.innerHTML += `<div>${msg}</div>`;
    });
  }).withFailureHandler(function(erro){
    document.getElementById('progressBar').style.display='none';
    status.innerHTML = `<div style="color:red;">Erro: ${erro.message}</div>`;
  }).uploadFiles({mes, ano, despesa, arquivos});
};

function toBase64(file) {
  return new Promise((resolve,reject)=>{
    let reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = err => reject(err);
    reader.readAsDataURL(file);
  });
}
</script>
</body>
</html>
