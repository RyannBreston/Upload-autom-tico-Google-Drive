<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Envio de Despesas - Grupo Tavares</title>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <style>
    :root {
      --primary: #e53935;
      --accent: #fff;
      --background: #191919;
      --card-bg: rgba(255,255,255,0.96);
      --shadow: 0 10px 40px 0 rgba(44,62,80,.15);
      --divider: #f0ecec;
      --input-bg: #f7f7fa;
    }
    body {
      min-height: 100vh;
      background: var(--background) url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80') center/cover fixed;
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .main-card {
      max-width: 480px;
      margin: 48px auto;
      border-radius: 24px;
      background: var(--card-bg);
      box-shadow: var(--shadow);
      padding: 0 34px 38px 34px;
      position: relative;
      overflow: hidden;
      border: 0;
      backdrop-filter: blur(7px);
    }
    .gt-header {
      background: transparent;
      padding: 38px 0 18px 0;
      text-align: center;
      border-radius: 0 0 16px 16px;
      box-shadow: none;
      margin-bottom: 12px;
      border-bottom: 2px solid var(--divider);
    }
    .gt-logo {
      width: 110px;
      height: 110px;
      object-fit: contain;
      background: transparent;
      margin-bottom: 14px;
      border-radius: 18px;
      box-shadow: 0 2px 14px #e5393535;
      padding: 8px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .gt-title {
      color: #e53935;
      font-size: 2.1rem;
      font-weight: 700;
      letter-spacing: 1.3px;
      margin-bottom: 3px;
      font-family: 'Montserrat', Arial, sans-serif;
      text-shadow: 0 3px 12px #fff9;
    }
    .gt-subtitle {
      color: #222;
      font-size: 1.1rem;
      font-weight: 400;
      margin-bottom: 0;
      opacity: .96;
      letter-spacing: 0.2px;
      text-shadow: 0 2px 6px #fff9;
    }
    .input-field label { color: #d32f2f; }
    .input-field input, .input-field select {
      background: var(--input-bg) !important;
      border: 1.5px solid #ececec !important;
      border-radius: 10px !important;
      padding-left: 13px !important;
      font-weight: 500;
      font-size: 1.07em;
    }
    .file-field .btn {
      background: var(--primary);
      border-radius: 13px;
      font-weight: 600;
      box-shadow: none;
      font-size: 1em;
      margin-right: 7px;
    }
    .btn {
      background: var(--primary);
      border-radius: 20px;
      font-weight: 700;
      font-size: 1.11em;
      letter-spacing: 1px;
      box-shadow: none;
      transition: background .2s;
      margin-bottom: 7px;
    }
    .btn:hover, .btn:focus {
      background: #ab2421;
    }
    .btn-flat {
      color: var(--primary) !important;
      font-weight: 600;
    }
    .btn-folder {
      background: #f5f5f5 !important;
      color: #e53935 !important;
      border-radius: 13px !important;
      font-weight: 600;
      margin-top: 0 !important;
      margin-bottom: 0 !important;
      box-shadow: none !important;
    }
    .progress { border-radius: 10px; height:10px; background: #fbe9e7;}
    .progress .determinate { background: var(--primary);}
    .progress-percentage { text-align:center; color:var(--primary); font-weight: 600; }
    .success-text { color: #388e3c; font-weight: 500; font-size: 1.04em;}
    .error-text { color: #c62828; font-weight: 500; font-size: 1.04em;}
    .collection .collection-item {
      border:none;
      background: #fafbfc;
      color:#222;
      border-radius: 8px;
      margin-bottom:4px;
      font-size:1.07em;
      box-shadow: 0 1px 6px #00000009;
    }
    .toast { border-radius: 24px; font-weight: 500; background: #263238 !important;}
    .required:after { content:" *"; color:#e53935; }
    .file-list { margin-bottom:10px; }
    .file-list li { font-size:0.99em; color:#37474f; }
    .gt-divider {
      border: 0;
      border-top: 2px solid var(--divider);
      margin: 28px 0 16px 0;
      width: 100%;
    }
    .row-despesa { 
      display: flex; 
      align-items: flex-end; 
      gap: 10px;
      margin-bottom: 0;
      margin-top: 6px;
    }
    .input-field { margin-top: 10px; }
    .btn-folder i { color: #e53935 !important; }
    .nova-conta-area {
      margin-top: -10px;
      margin-bottom: 18px;
      padding: 9px 0 0 0;
    }
    @media(max-width:600px) { 
      .main-card {
        max-width:100vw;
        margin:0;
        padding: 2vw 2vw 30px 2vw;
      }
      .gt-title {font-size:1.25rem;}
      .gt-header{padding-top:26px;}
      .row-despesa { flex-direction: column; align-items:initial; gap:0;}
      .row-despesa .input-field {width:100%; margin-bottom:0;}
      .nova-conta-area {margin-bottom:14px;}
    }
  </style>
</head>
<body>
  <div class="main-card z-depth-2">
    <div class="gt-header">
      <img src="https://user-images.githubusercontent.com/130085569/275192936-0ca0e3b8-7b8a-4533-9a71-0b3b5c2ce2b9.png" class="gt-logo" alt="Logotipo Grupo Tavares">
      <div class="gt-title">Envio de Despesas</div>
      <div class="gt-subtitle">Grupo Tavares</div>
    </div>
    <form id="uploadForm" autocomplete="off" style="margin-top:18px;">
      <div class="file-field input-field">
        <div class="btn">
          <span><i class="material-icons left">cloud_upload</i>Selecionar</span>
          <input type="file" id="arquivo" multiple accept=".pdf,.jpg,.jpeg,.png" required aria-label="Selecione os arquivos para upload">
        </div>
        <div class="file-path-wrapper">
          <input class="file-path validate" type="text" placeholder="Selecione os arquivos">
        </div>
        <ul id="fileList" class="file-list"></ul>
      </div>
      <div class="input-field">
        <select id="ano" required></select>
        <label for="ano" class="required">Ano</label>
      </div>
      <div class="input-field">
        <select id="mes" required aria-label="Selecione o mês">
          <option value="" disabled selected>Escolha o mês</option>
          <option value="01">Janeiro</option><option value="02">Fevereiro</option>
          <option value="03">Março</option><option value="04">Abril</option>
          <option value="05">Maio</option><option value="06">Junho</option>
          <option value="07">Julho</option><option value="08">Agosto</option>
          <option value="09">Setembro</option><option value="10">Outubro</option>
          <option value="11">Novembro</option><option value="12">Dezembro</option>
        </select>
        <label for="mes" class="required">Mês</label>
      </div>
      <div class="input-field">
        <input id="despesa" type="text" required placeholder="Ex: 284 - Comissão Vendedores" autocomplete="off" list="listaDespesas" aria-label="Conta de Despesa">
        <label for="despesa" class="required">Conta de Despesa</label>
        <datalist id="listaDespesas"></datalist>
      </div>
      <div class="nova-conta-area">
        <div class="input-field" style="margin-top:0;">
          <input id="novaDespesa" type="text" placeholder="Ex: 999 - Nova Conta" autocomplete="off" aria-label="Nova conta de despesa">
          <label for="novaDespesa">Criar Nova Conta de Despesa</label>
        </div>
      </div>
      <div class="row-despesa">
        <button id="btnVerPasta" type="button" class="btn btn-folder" title="Ver pasta no Google Drive">
          <i class="material-icons left">folder_open</i>Pasta
        </button>
      </div>
      <div class="center-align" style="margin-top:24px;">
        <button type="submit" class="btn waves-effect waves-light">
          <i class="material-icons left">send</i>Enviar
        </button>
        <button type="reset" class="btn-flat waves-effect" style="margin-left:10px;">Limpar</button>
      </div>
    </form>
    <div class="progress" id="progressBar" style="display:none;">
      <div class="determinate" style="width:0%;"></div>
    </div>
    <div class="progress-percentage" id="progressPercentage" style="display:none;">0%</div>
    <div id="status" style="margin-top:12px;"></div>
    <hr class="gt-divider">
    <h6 class="center-align" style="color:#7e7e7e;font-weight:600;margin-top:10px;letter-spacing:0.2px;">Últimos Arquivos Enviados</h6>
    <ul id="uploadedFiles" class="collection"></ul>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      M.AutoInit();
      let anoAtual = new Date().getFullYear();
      let selectAno = document.getElementById('ano');
      for(let a=anoAtual; a >= anoAtual-10; a--) {
        let opt = document.createElement('option');
        opt.value = a; opt.textContent = a;
        selectAno.appendChild(opt);
      }
    });

    document.getElementById('arquivo').addEventListener('change', updateFileList);

    function updateFileList() {
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = '';
      const files = document.getElementById('arquivo').files;
      if (files.length > 5) {
        M.toast({html: 'Selecione no máximo 5 arquivos.'});
        document.getElementById('arquivo').value = "";
        fileList.innerHTML = '';
        return;
      }
      let totalMb = Array.from(files).reduce((s,f)=>s+f.size,0)/1048576;
      if (totalMb > 10) {
        M.toast({html: 'O total dos arquivos não pode exceder 10MB.'});
        document.getElementById('arquivo').value = "";
        fileList.innerHTML = '';
        return;
      }
      for (let i = 0; i < files.length; i++) {
        const li = document.createElement('li');
        li.innerHTML = `<i class="material-icons left" style="font-size:1.1em;color:#e53935;">description</i>${files[i].name} <span style="color:#607d8b;font-size:0.93em;">(${(files[i].size/1048576).toFixed(2)} MB)</span>`;
        fileList.appendChild(li);
      }
    }

    document.getElementById('ano').addEventListener('change', updateUploadedList);
    document.getElementById('mes').addEventListener('change', updateUploadedList);
    document.getElementById('despesa').addEventListener('blur', updateUploadedList);
    document.getElementById('novaDespesa').addEventListener('blur', updateUploadedList);

    function getDespesaSelecionada() {
      let nova = document.getElementById('novaDespesa').value.trim();
      if(nova) return nova;
      return document.getElementById('despesa').value.trim();
    }

    function updateUploadedList() {
      const ano = document.getElementById('ano').value;
      const mes = document.getElementById('mes').value;
      const despesa = getDespesaSelecionada();
      const ul = document.getElementById('uploadedFiles');
      ul.innerHTML = '<li class="collection-item">Carregando...</li>';
      if (!ano || !mes || !despesa) {
        ul.innerHTML = '';
        return;
      }
      google.script.run.withSuccessHandler(function(files){
        if (!files.length) {
          ul.innerHTML = '<li class="collection-item">Nenhum arquivo enviado ainda.</li>';
          return;
        }
        ul.innerHTML = files.map(f =>
          `<li class="collection-item">
            <a href="${f.url}" target="_blank" style="font-weight:500;color:#e53935;text-decoration:underline">
              <i class="material-icons left green-text">file_present</i>${f.name}
            </a>
            <span style="color:#789;"> &mdash; ${f.date}</span>
          </li>`
        ).join('');
      }).listUploadedFiles(ano, mes, despesa);
    }

    function carregarDespesas() {
      google.script.run.withSuccessHandler(function(lista){
        const datalist = document.getElementById('listaDespesas');
        datalist.innerHTML = '';
        lista.forEach(function(item){
          const opt = document.createElement('option');
          opt.value = item;
          datalist.appendChild(opt);
        });
      }).getContasDespesas();
    }

    window.onload = function() {
      updateUploadedList();
      carregarDespesas();
    };

    document.getElementById('uploadForm').onsubmit = async function(e){
      e.preventDefault();
      const status = document.getElementById('status');
      status.innerHTML = '';
      let files = document.getElementById('arquivo').files;
      if (!files.length) return M.toast({html: 'Selecione ao menos um arquivo.'});
      if (files.length > 5) return M.toast({html: 'Selecione no máximo 5 arquivos.'});
      let totalMb = Array.from(files).reduce((s,f)=>s+f.size,0)/1048576;
      if (totalMb > 10) return M.toast({html:'O tamanho total não pode passar de 10MB.'});
      let arquivos = [];
      for (let file of files) {
        if (!["application/pdf","image/jpeg","image/png"].includes(file.type)) {
          return M.toast({html:`Tipo de arquivo não permitido: ${file.name}`});
        }
        let base64 = await toBase64(file);
        arquivos.push({name: file.name, type: file.type, data: base64.split(',')[1]});
      }
      let mes = document.getElementById('mes').value;
      let ano = document.getElementById('ano').value;
      let despesa = getDespesaSelecionada();
      if (!mes || !ano || !despesa) return M.toast({html: 'Preencha todos os campos.'});

      document.querySelector('button[type=submit]').disabled = true;

      document.getElementById('progressBar').style.display='block';
      document.getElementById('progressPercentage').style.display='block';
      document.querySelector('.progress .determinate').style.width = '0%';
      document.getElementById('progressPercentage').innerText = '0%';

      let fake = 0;
      let interval = setInterval(()=>{
        if(fake<90){
          fake++;
          document.querySelector('.progress .determinate').style.width = fake+'%';
          document.getElementById('progressPercentage').innerText = fake+'%';
        } else {
          clearInterval(interval);
        }
      }, 18);

      let estimativa = (totalMb * 2).toFixed(0);
      M.toast({html:`Enviando... Pode levar cerca de ${estimativa} segundos.`});

      let novaDespesa = document.getElementById('novaDespesa').value.trim();

      google.script.run.withSuccessHandler(function(resp){
        clearInterval(interval);
        document.getElementById('progressBar').style.display='none';
        document.getElementById('progressPercentage').style.display='none';
        document.querySelector('button[type=submit]').disabled = false;
        if(resp.success){
          M.toast({html: 'Upload realizado com sucesso!'});
          status.innerHTML = resp.mensagens.map(m=>`<div class="success-text">${m}</div>`).join('');
          document.getElementById('uploadForm').reset();
          document.getElementById('fileList').innerHTML = '';
          carregarDespesas();
          updateUploadedList();
        }else{
          status.innerHTML = resp.mensagens.map(m=>`<div class="error-text">${m}</div>`).join('');
        }
      }).withFailureHandler(function(erro){
        clearInterval(interval);
        document.getElementById('progressBar').style.display='none';
        document.getElementById('progressPercentage').style.display='none';
        document.querySelector('button[type=submit]').disabled = false;
        status.innerHTML = `<div class="error-text">Erro: ${erro.message}</div>`;
      }).uploadFiles({mes, ano, despesa, arquivos, novaDespesa});
    };

    document.getElementById('btnVerPasta').onclick = function() {
      let ano = document.getElementById('ano').value;
      let mes = document.getElementById('mes').value;
      let despesa = getDespesaSelecionada();
      if(!ano || !mes || !despesa) {
        M.toast({html:"Selecione ano, mês e despesa!"});
        return;
      }
      google.script.run.withSuccessHandler(function(url){
        if(url) {
          window.open(url, "_blank");
        } else {
          M.toast({html:"Pasta não encontrada ou criada ainda!"});
        }
      }).getFolderUrl(ano, mes, despesa);
    };

    function toBase64(file) {
      return new Promise((resolve,reject)=>{
        let reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
