<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Gestão de Despesas - Grupo Tavares</title>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <style>
    :root {
      --primary: #b71c1c;
      --primary-light: #e57373;
      --primary-dark: #7f1111;
      --background: #f4f6fa;
      --card: #fff;
      --shadow: 0 8px 32px 0 rgba(44,62,80,.10);
      --text-main: #23272b;
      --input-bg: #f9f9f9;
      --input-border: #e0e0e0;
      --divider: #ececec;
    }
    body {
      background: var(--background);
      font-family: 'Montserrat', Arial, sans-serif;
      color: var(--text-main);
      margin: 0;
      padding: 0;
    }
    .main-card {
      max-width: 540px;
      margin: 56px auto 36px auto;
      border-radius: 18px;
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 0 34px 38px 34px;
      position: relative;
      overflow: hidden;
      border: 1.5px solid var(--divider);
    }
    .gt-header {
      background: #fff;
      padding: 36px 0 18px 0;
      text-align: center;
      border-radius: 0 0 16px 16px;
      box-shadow: none;
      margin-bottom: 8px;
      border-bottom: 2px solid var(--divider);
    }
    .gt-logo {
      width: 96px;
      height: 96px;
      object-fit: contain;
      background: #fff;
      margin-bottom: 12px;
      border-radius: 16px;
      border: 2px solid #ececec;
      display: block;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 1px 6px #00000014;
    }
    .gt-title {
      color: var(--text-main);
      font-size: 2.2rem;
      font-weight: 600;
      margin-bottom: 2px;
      letter-spacing: 1.2px;
      text-shadow: none;
    }
    .gt-subtitle {
      color: #8a8a8a;
      font-size: 1.08rem;
      font-weight: 400;
      margin-bottom: 0;
      opacity: .93;
      letter-spacing: 0.2px;
    }
    .input-field label { color: var(--primary-dark);}
    .input-field input, .input-field select {
      background: var(--input-bg) !important;
      border: 1.5px solid var(--input-border) !important;
      border-radius: 10px !important;
      padding-left: 12px !important;
      font-weight: 500;
      font-size: 1.03em;
    }
    .file-field .btn {
      background: var(--primary);
      border-radius: 12px;
      font-weight: 600;
      box-shadow: none;
      font-size: 1em;
      margin-right: 6px;
    }
    .btn {
      background: var(--primary);
      border-radius: 18px;
      font-weight: 600;
      font-size: 1.08em;
      box-shadow: none;
      transition: background .2s;
      letter-spacing: 1px;
    }
    .btn:hover, .btn:focus {
      background: var(--primary-dark);
    }
    .btn-flat {
      color: var(--primary) !important;
      font-weight: 600;
    }
    .btn-folder {
      background: #ececec !important;
      color: var(--primary-dark) !important;
      border-radius: 13px !important;
      font-weight: 600;
      margin-top: 0 !important;
      margin-bottom: 0 !important;
      box-shadow: none !important;
    }
    .progress { border-radius: 10px; height:10px; background: var(--primary-light);}
    .progress .determinate { background: var(--primary);}
    .progress-percentage { text-align:center; color:var(--primary); font-weight: 600; }
    .success-text { color: #388e3c; font-weight: 500; font-size: 1.04em;}
    .error-text { color: #c62828; font-weight: 500; font-size: 1.04em;}
    .collection .collection-item {
      border:none;
      background: #f7f7fa;
      color:#263238;
      border-radius: 8px;
      margin-bottom:5px;
      font-size:1.07em;
      box-shadow: 0 1px 6px #00000009;
    }
    .toast { border-radius: 24px; font-weight: 500; background: #263238 !important;}
    .required:after { content:" *"; color:#b71c1c; }
    .file-list { margin-bottom:10px; }
    .file-list li { font-size:0.99em; color:#37474f; }
    #envioDica { color:#607d8b;font-size:0.97em;margin-bottom:10px; }
    .gt-divider {
      border: 0;
      border-top: 2px solid var(--divider);
      margin: 26px 0 16px 0;
      width: 100%;
    }
    .row-despesa { 
      display: flex; 
      align-items: flex-end; 
      gap: 10px;
      margin-bottom: 0;
      margin-top: 6px;
    }
    .input-field { margin-top: 10px; }
    .btn-folder i { color: var(--primary-dark) !important; }
    @media(max-width:600px) { 
      .main-card {
        max-width:100vw;
        margin:0;
        padding: 2vw 2vw 30px 2vw;
      }
      .gt-title {font-size:1.25rem;}
      .gt-header{padding-top:26px;}
      .row-despesa { flex-direction: column; align-items:initial; gap:0;}
      .row-despesa .input-field {width:100%; margin-bottom:0;}
    }
  </style>
</head>
<body>
  <div class="main-card z-depth-2">
    <div class="gt-header">
      <img src="https://drive.google.com/uc?export=view&id=1pdzQtOp0iGQOMPDXvJex5qyNoNpZRmak" class="gt-logo" alt="Logotipo Grupo Tavares">
      <div class="gt-title">Gestão de Despesas</div>
      <div class="gt-subtitle">Envie comprovantes em PDF, JPG ou PNG<br>Máx. 5 arquivos e 10MB no total</div>
    </div>
    <div id="envioDica" class="center-align">
      O envio pode levar alguns segundos, dependendo do tamanho dos arquivos e da sua conexão.<br>
      <b>Dica:</b> Prefira arquivos menores que 3MB para maior agilidade.
    </div>
    <form id="uploadForm" autocomplete="off" style="margin-top:18px;">
      <div class="file-field input-field">
        <div class="btn">
          <span><i class="material-icons left">cloud_upload</i>Selecionar</span>
          <input type="file" id="arquivo" multiple accept=".pdf,.jpg,.jpeg,.png" required aria-label="Selecione os arquivos para upload">
        </div>
        <div class="file-path-wrapper">
          <input class="file-path validate" type="text" placeholder="Selecione os arquivos">
        </div>
        <ul id="fileList" class="file-list"></ul>
      </div>
      <div class="input-field">
        <select id="ano" required></select>
        <label for="ano" class="required">Ano</label>
      </div>
      <div class="input-field">
        <select id="mes" required aria-label="Selecione o mês">
          <option value="" disabled selected>Escolha o mês</option>
          <option value="01">Janeiro</option><option value="02">Fevereiro</option>
          <option value="03">Março</option><option value="04">Abril</option>
          <option value="05">Maio</option><option value="06">Junho</option>
          <option value="07">Julho</option><option value="08">Agosto</option>
          <option value="09">Setembro</option><option value="10">Outubro</option>
          <option value="11">Novembro</option><option value="12">Dezembro</option>
        </select>
        <label for="mes" class="required">Mês</label>
      </div>
      <div class="row-despesa">
        <div class="input-field" style="flex:2;">
          <input id="despesa" type="text" required placeholder="Ex: 284 - Comissão Vendedores" autocomplete="off" list="listaDespesas" aria-label="Conta de Despesa">
          <label for="despesa" class="required">Conta de Despesa</label>
          <datalist id="listaDespesas"></datalist>
        </div>
        <div class="input-field" style="flex:2;">
          <input id="novaDespesa" type="text" placeholder="Ex: 999 - Nova Conta" autocomplete="off" aria-label="Nova conta de despesa">
          <label for="novaDespesa">NOVA CONTA DE DESPESA</label>
        </div>
        <button id="btnVerPasta" type="button" class="btn btn-folder" title="Ver pasta no Google Drive">
          <i class="material-icons left">folder_open</i>Pasta
        </button>
      </div>
      <div class="center-align" style="margin-top:24px;">
        <button type="submit" class="btn waves-effect waves-light">
          <i class="material-icons left">send</i>Enviar
        </button>
        <button type="reset" class="btn-flat waves-effect" style="margin-left:10px;">Limpar</button>
      </div>
    </form>
    <div class="progress" id="progressBar" style="display:none;">
      <div class="determinate" style="width:0%;"></div>
    </div>
    <div class="progress-percentage" id="progressPercentage" style="display:none;">0%</div>
    <div id="status" style="margin-top:12px;"></div>
    <hr class="gt-divider">
    <h6 class="center-align" style="color:#7e7e7e;font-weight:600;margin-top:10px;letter-spacing:0.2px;">Últimos Arquivos Enviados</h6>
    <ul id="uploadedFiles" class="collection"></ul>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      M.AutoInit();
      let anoAtual = new Date().getFullYear();
      let selectAno = document.getElementById('ano');
      for(let a=anoAtual; a >= anoAtual-10; a--) {
        let opt = document.createElement('option');
        opt.value = a; opt.textContent = a;
        selectAno.appendChild(opt);
      }
    });

    document.getElementById('arquivo').addEventListener('change', updateFileList);

    function updateFileList() {
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = '';
      const files = document.getElementById('arquivo').files;
      if (files.length > 5) {
        M.toast({html: 'Selecione no máximo 5 arquivos.'});
        document.getElementById('arquivo').value = "";
        fileList.innerHTML = '';
        return;
      }
      let totalMb = Array.from(files).reduce((s,f)=>s+f.size,0)/1048576;
      if (totalMb > 10) {
        M.toast({html: 'O total dos arquivos não pode exceder 10MB.'});
        document.getElementById('arquivo').value = "";
        fileList.innerHTML = '';
        return;
      }
      for (let i = 0; i < files.length; i++) {
        const li = document.createElement('li');
        li.innerHTML = `<i class="material-icons left" style="font-size:1.1em;color:#b71c1c;">description</i>${files[i].name} <span style="color:#607d8b;font-size:0.93em;">(${(files[i].size/1048576).toFixed(2)} MB)</span>`;
        fileList.appendChild(li);
      }
    }

    document.getElementById('ano').addEventListener('change', updateUploadedList);
    document.getElementById('mes').addEventListener('change', updateUploadedList);
    document.getElementById('despesa').addEventListener('blur', updateUploadedList);
    document.getElementById('novaDespesa').addEventListener('blur', updateUploadedList);

    function getDespesaSelecionada() {
      let nova = document.getElementById('novaDespesa').value.trim();
      if(nova) return nova;
      return document.getElementById('despesa').value.trim();
    }

    function updateUploadedList() {
      const ano = document.getElementById('ano').value;
      const mes = document.getElementById('mes').value;
      const despesa = getDespesaSelecionada();
      const ul = document.getElementById('uploadedFiles');
      ul.innerHTML = '<li class="collection-item">Carregando...</li>';
      if (!ano || !mes || !despesa) {
        ul.innerHTML = '';
        return;
      }
      google.script.run.withSuccessHandler(function(files){
        if (!files.length) {
          ul.innerHTML = '<li class="collection-item">Nenhum arquivo enviado ainda.</li>';
          return;
        }
        ul.innerHTML = files.map(f =>
          `<li class="collection-item">
            <a href="${f.url}" target="_blank" style="font-weight:500;color:#b71c1c;text-decoration:underline">
              <i class="material-icons left green-text">file_present</i>${f.name}
            </a>
            <span style="color:#789;"> &mdash; ${f.date}</span>
          </li>`
        ).join('');
      }).listUploadedFiles(ano, mes, despesa);
    }

    // Buscar lista de contas de despesa e preencher datalist
    function carregarDespesas() {
      google.script.run.withSuccessHandler(function(lista){
        const datalist = document.getElementById('listaDespesas');
        datalist.innerHTML = '';
        lista.forEach(function(item){
          const opt = document.createElement('option');
          opt.value = item;
          datalist.appendChild(opt);
        });
      }).getContasDespesas();
    }

    window.onload = function() {
      updateUploadedList();
      carregarDespesas();
    };

    document.getElementById('uploadForm').onsubmit = async function(e){
      e.preventDefault();
      const status = document.getElementById('status');
      status.innerHTML = '';
      let files = document.getElementById('arquivo').files;
      if (!files.length) return M.toast({html: 'Selecione ao menos um arquivo.'});
      if (files.length > 5) return M.toast({html: 'Selecione no máximo 5 arquivos.'});
      let totalMb = Array.from(files).reduce((s,f)=>s+f.size,0)/1048576;
      if (totalMb > 10) return M.toast({html:'O tamanho total não pode passar de 10MB.'});
      let arquivos = [];
      for (let file of files) {
        if (!["application/pdf","image/jpeg","image/png"].includes(file.type)) {
          return M.toast({html:`Tipo de arquivo não permitido: ${file.name}`});
        }
        let base64 = await toBase64(file);
        arquivos.push({name: file.name, type: file.type, data: base64.split(',')[1]});
      }
      let mes = document.getElementById('mes').value;
      let ano = document.getElementById('ano').value;
      let despesa = getDespesaSelecionada();
      if (!mes || !ano || !despesa) return M.toast({html: 'Preencha todos os campos.'});

      document.querySelector('button[type=submit]').disabled = true;

      document.getElementById('progressBar').style.display='block';
      document.getElementById('progressPercentage').style.display='block';
      document.querySelector('.progress .determinate').style.width = '0%';
      document.getElementById('progressPercentage').innerText = '0%';

      let fake = 0;
      let interval = setInterval(()=>{
        if(fake<90){
          fake++;
          document.querySelector('.progress .determinate').style.width = fake+'%';
          document.getElementById('progressPercentage').innerText = fake+'%';
        } else {
          clearInterval(interval);
        }
      }, 18);

      let estimativa = (totalMb * 2).toFixed(0);
      M.toast({html:`Enviando... Pode levar cerca de ${estimativa} segundos.`});

      // Checa se criou uma nova despesa, para salvar na planilha
      let novaDespesa = document.getElementById('novaDespesa').value.trim();

      google.script.run.withSuccessHandler(function(resp){
        clearInterval(interval);
        document.getElementById('progressBar').style.display='none';
        document.getElementById('progressPercentage').style.display='none';
        document.querySelector('button[type=submit]').disabled = false;
        if(resp.success){
          M.toast({html: 'Upload realizado com sucesso!'});
          status.innerHTML = resp.mensagens.map(m=>`<div class="success-text">${m}</div>`).join('');
          document.getElementById('uploadForm').reset();
          document.getElementById('fileList').innerHTML = '';
          carregarDespesas(); // Atualiza sugestões se nova despesa foi criada
          updateUploadedList();
        }else{
          status.innerHTML = resp.mensagens.map(m=>`<div class="error-text">${m}</div>`).join('');
        }
      }).withFailureHandler(function(erro){
        clearInterval(interval);
        document.getElementById('progressBar').style.display='none';
        document.getElementById('progressPercentage').style.display='none';
        document.querySelector('button[type=submit]').disabled = false;
        status.innerHTML = `<div class="error-text">Erro: ${erro.message}</div>`;
      }).uploadFiles({mes, ano, despesa, arquivos, novaDespesa});
    };

    // Botão "Ver Pasta"
    document.getElementById('btnVerPasta').onclick = function() {
      let ano = document.getElementById('ano').value;
      let mes = document.getElementById('mes').value;
      let despesa = getDespesaSelecionada();
      if(!ano || !mes || !despesa) {
        M.toast({html:"Selecione ano, mês e despesa!"});
        return;
      }
      google.script.run.withSuccessHandler(function(url){
        if(url) {
          window.open(url, "_blank");
        } else {
          M.toast({html:"Pasta não encontrada ou criada ainda!"});
        }
      }).getFolderUrl(ano, mes, despesa);
    };

    function toBase64(file) {
      return new Promise((resolve,reject)=>{
        let reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
